{% extends 'base.html' %}
{% block content %}
{% load custom_tags %}
<div class="container mt-4">
    <div class="card shadow-sm">
        <div class="card-body">
            <h1 class="card-title display-6 mb-3">{{ task.title }}</h1>
            <p class="card-text">{{ task.description }}</p>

            <p>
                <strong>Status:</strong>
                <span class="badge bg-primary">{{ task.status }}</span>
            </p>
            <p>
                <strong>Priority:</strong>
                <span class="badge bg-warning text-muted">{{ task.priority }}</span>
            </p>

            <div class="d-flex gap-2 mt-4">
                <a href="{% url 'task_tracking:task-update' task.pk %}" class="btn btn-outline-primary">‚úèÔ∏è Update</a>
                <a href="{% url 'task_tracking:task-delete' task.pk %}" class="btn btn-outline-danger">üóëÔ∏è Delete</a>
                <a href="{% url 'task_tracking:task-list' %}" class="btn btn-secondary ms-auto">‚Üê Back to Task List</a>
            </div>

            <hr class="my-4">

            <div class="add-comment mt-4">
                <h4>–î–æ–¥–∞—Ç–∏ –∫–æ–º–µ–Ω—Ç–∞—Ä</h4>
                <form action="{% url 'task_tracking:task-detail' task.id %}" method="post" enctype="multipart/form-data">
                    {% csrf_token %}
                    {{ comment_form.as_p }}
                    <button type="submit" class="btn btn-primary">–í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏</button>
                </form>
            </div>

            <h3 class="mb-3">Comments</h3>
            <div class="list-group">
                {% for comment in task.comments.all %}
                    <div class="list-group-item mb-3">
                        <p class="mb-1">{{ comment.content }}</p>
                        {% if comment.media %}
                            <div class="comment-media">
                                {% if comment.media.url|endswith:".jpg" or comment.media.url|endswith:".png" or comment.media.url|endswith:".jpeg" %}
                                    <img src="{{ comment.media.url }}" alt="–ó–æ–±—Ä–∞–∂–µ–Ω–Ω—è –∫–æ–º–µ–Ω—Ç–∞—Ä—è" style="max-width: 1000px;">
                                {% elif comment.media.url|endswith:".mp4" %}
                                    <video width="320" height="240" controls>
                                        <source src="{{ comment.media.url }}" type="video/mp4">
                                        Your browser does not support the video tag.
                                    </video>
                                {% else %}
                                    <a href="{{ comment.media.url }}">–ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —Ñ–∞–π–ª</a>
                                {% endif %}
                            </div>
                        {% endif %}
                        <small class="text-muted">
                            By {{ comment.author.username }} on {{ comment.created_at|date:"M d, Y H:i" }}
                        </small>
                        {% if request.user == comment.author %}
                            <div class="mt-2">
                                <a href="{% url 'task_tracking:comment-delete' comment.pk %}" class="btn btn-sm btn-outline-danger">üóëÔ∏è Delete Comment</a>
                            </div>
                        {% endif %}
                        <form action="{% url 'task_tracking:comment-like-toggle' comment.id %}" method="post">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-sm btn-outline-primary {% if request.user in comment.likes.all %}btn-success{% else %}btn-outline-success{% endif %}">
                                Like ({{ comment.likes.count }})
                            </button>
                        </form>
                    </div>
                {% empty %}
                    <div class="text-muted">No comments yet.</div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>
{% endblock %}
